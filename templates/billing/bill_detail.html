{% extends "layout.html" %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<h1>{{ title }}</h1>

<div class="card mb-4">
     <div class="card-header">
        Bill Summary (Aggregated from {{ order_ids_str|length }} order(s))
    </div>
    <div class="card-body">
        {% if items %}
        <table class="table table-sm table-striped">
            <thead>
                <tr>
                    <th>Item Name</th>
                    <th class="text-end">Qty</th>
                    <th class="text-end">Price Each</th>
                    <th class="text-end">Subtotal</th>
                </tr>
            </thead>
            <tbody>
                {% for item in items %}
                <tr>
                    <td>{{ item.name }}</td>
                    <td class="text-end">{{ item.quantity }}</td>
                    <td class="text-end">${{ item.price_each_str }}</td>
                    <td class="text-end">${{ item.subtotal_str }}</td>
                </tr>
                {% endfor %}
            </tbody>
             <tfoot class="table-group-divider">
                <tr>
                    <th colspan="3" class="text-end fs-4">Grand Total:</th>
                    <th class="text-end fs-4">${{ grand_total_str }}</th>
                </tr>
            </tfoot>
        </table>
        {% else %}
        <p class="text-danger">Error: No items found for this bill calculation.</p>
        {% endif %}
    </div>
</div>

{# Payment Form #}
<div class="card">
     <div class="card-header">
        Process Payment
    </div>
     <div class="card-body">
         <form action="{{ url_for('billing.mark_as_paid', table_id_str=table._id) }}" method="POST">
            {# Pass the order IDs being billed so the backend knows which ones to update #}
            {% for oid in order_ids_str %}
            <input type="hidden" name="order_ids[]" value="{{ oid }}">
            {% endfor %}

            <div class="row align-items-end">
                <div class="col-md-4 mb-3">
                    <label for="payment_method" class="form-label">Payment Method</label>
                    <select name="payment_method" id="payment_method" class="form-select">
                        <option value="Cash">Cash</option>
                        <option value="Card">Card</option>
                        <option value="Online">Online Transfer</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="col-md-4 mb-3">
                    <p class="fs-5">Amount Due: <strong>${{ grand_total_str }}</strong></p>
                </div>
                 <div class="col-md-4 mb-3 text-end">
                    <button type="submit" class="btn btn-success btn-lg" onclick="return confirm('Confirm payment of ${{ grand_total_str }} has been received for Table {{ table.number }}?')">
                        Mark as Paid & Free Table
                    </button>
                </div>
            </div>
         </form>
     </div>
</div>


<div class="mt-4">
    <a href="{{ url_for('billing.index') }}" class="btn btn-secondary">Back to Billing Dashboard</a>
    {# Link back to orders list maybe? #}
     <a href="{{ url_for('orders.list_orders', filter_status='active') }}" class="btn btn-outline-secondary">View Active Orders</a>
</div>

{% endblock %}