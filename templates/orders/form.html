{% extends "layout.html" %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<h1>{{ title }}</h1>

<form method="POST" action="{{ url_for('orders.new_order') }}" id="order-form">
    <div class="row">
        <div class="col-md-4 mb-3">
            <label for="table_id" class="form-label">Table *</label>
            <select class="form-select" id="table_id" name="table_id" required>
                <option value="">Select a table...</option>
                {% for table in tables %}
                <option value="{{ table._id }}" {{ 'selected' if current_data and current_data.table_id == table._id|string }}>
                    Table {{ table.number }} (Cap: {{ table.capacity }}, Status: {{ table.status }})
                </option>
                {% endfor %}
            </select>
             {% if not tables %}
             <div class="form-text text-danger">No available tables found. Please add or free up tables.</div>
             {% endif %}
        </div>
    </div>

    <hr>
    <h4>Order Items *</h4>
    <div id="order-items-container">
        {# Item rows will be added here by JavaScript #}
        {# Example of a single row structure (for JS reference)
        <div class="row order-item-row mb-2 align-items-center">
            <div class="col-md-6">
                <select name="item_id[]" class="form-select item-select" required>
                    <option value="">Select Item...</option>
                     # Options added by JS #
                </select>
            </div>
            <div class="col-md-2">
                <input type="number" name="quantity[]" class="form-control quantity-input" min="1" value="1" required>
            </div>
             <div class="col-md-2 item-price">
                $0.00
            </div>
            <div class="col-md-2">
                <button type="button" class="btn btn-sm btn-danger remove-item-btn">Remove</button>
            </div>
        </div>
         #}
    </div>

    <button type="button" class="btn btn-sm btn-outline-success mt-2" id="add-item-btn">Add Item</button>

    <hr>
     <div class="mb-3">
        <label for="notes" class="form-label">Order Notes (Optional)</label>
        <textarea class="form-control" id="notes" name="notes" rows="2">{{ current_data.notes if current_data else '' }}</textarea>
    </div>

    {# Display calculated total (optional, JS updates this) #}
    {# <div class="mt-3">
        <h4>Estimated Total: $<span id="estimated-total">0.00</span></h4>
    </div> #}

    <div class="mt-4">
        <button type="submit" class="btn btn-primary" {% if not tables or not menu_items %}disabled{% endif %}>Place Order</button>
        <a href="{{ url_for('orders.list_orders') }}" class="btn btn-secondary">Cancel</a>
         {% if not menu_items %}
         <span class="text-danger ms-2">Cannot place order: No available menu items found.</span>
         {% endif %}
    </div>
</form>

{# Template for a new item row (used by JavaScript) #}
<template id="order-item-template">
    <div class="row order-item-row mb-2 align-items-center">
        <div class="col-md-6">
            <select name="item_id[]" class="form-select item-select" required>
                <option value="" data-price="0">Select Item...</option>
                {% for item in menu_items %}
                <option value="{{ item._id }}" data-price="{{ item.price }}">{{ item.name }} ({{ item.category }}) - ${{ "%.2f"|format(item.price) }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-2">
            <input type="number" name="quantity[]" class="form-control quantity-input" min="1" value="1" required>
        </div>
        <div class="col-md-2 item-price">
            $0.00 {# Updated by JS #}
        </div>
        <div class="col-md-2">
            <button type="button" class="btn btn-sm btn-danger remove-item-btn">Remove</button>
        </div>
    </div>
</template>

{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const container = document.getElementById('order-items-container');
        const addButton = document.getElementById('add-item-btn');
        const template = document.getElementById('order-item-template');
        // const totalSpan = document.getElementById('estimated-total'); // Optional total display

        function addRow() {
            const clone = template.content.cloneNode(true);
            container.appendChild(clone);
            // Add event listeners to the new row
            const newRow = container.lastElementChild;
            newRow.querySelector('.remove-item-btn').addEventListener('click', removeRow);
            newRow.querySelector('.item-select').addEventListener('change', updatePrice);
            newRow.querySelector('.quantity-input').addEventListener('input', updatePrice);
            updatePrice({ target: newRow.querySelector('.item-select') }); // Update price on add
        }

        function removeRow(event) {
            event.target.closest('.order-item-row').remove();
            // updateTotal(); // Optional
        }

        function updatePrice(event) {
             // Find the row where the change happened
            const row = event.target.closest('.order-item-row');
            if (!row) return;

            const select = row.querySelector('.item-select');
            const quantityInput = row.querySelector('.quantity-input');
            const priceDisplay = row.querySelector('.item-price');

            const selectedOption = select.selectedOptions[0];
            const price = parseFloat(selectedOption.getAttribute('data-price') || 0);
            const quantity = parseInt(quantityInput.value) || 0;

            const subtotal = price * quantity;
            priceDisplay.textContent = '$' + subtotal.toFixed(2);

            // updateTotal(); // Optional
        }

         // Optional: Calculate and display total dynamically
        // function updateTotal() {
        //     let grandTotal = 0;
        //     container.querySelectorAll('.order-item-row').forEach(row => {
        //         const select = row.querySelector('.item-select');
        //         const quantityInput = row.querySelector('.quantity-input');
        //         const price = parseFloat(select.selectedOptions[0].getAttribute('data-price') || 0);
        //         const quantity = parseInt(quantityInput.value) || 0;
        //         grandTotal += price * quantity;
        //     });
        //     totalSpan.textContent = grandTotal.toFixed(2);
        // }


        // Add event listener for the main add button
        addButton.addEventListener('click', addRow);

        // Add event listeners for any existing remove buttons (if loading saved data)
        container.querySelectorAll('.remove-item-btn').forEach(button => {
            button.addEventListener('click', removeRow);
        });
         // Add event listeners for existing select/inputs (if loading saved data)
        container.querySelectorAll('.item-select').forEach(select => {
             select.addEventListener('change', updatePrice);
             updatePrice({ target: select }); // Initial price update
        });
        container.querySelectorAll('.quantity-input').forEach(input => {
            input.addEventListener('input', updatePrice);
        });


        // Add at least one row when the page loads if container is empty
        if (container.children.length === 0) {
            addRow();
        }

         // Optional: Initial total calculation on load
        // updateTotal();
    });
</script>
{% endblock %}