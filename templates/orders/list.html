{% extends "layout.html" %}

{% block title %}{{ title }}{% endblock %}

{% block scripts %}
{# Optional: Add JS for real-time updates or better filtering later #}
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
    <h1>{{ title }}</h1>
    <a href="{{ url_for('orders.new_order') }}" class="btn btn-success">New Order</a>
</div>

{# Filter Buttons #}
<div class="mb-3 btn-group" role="group" aria-label="Filter orders by status">
    <a href="{{ url_for('orders.list_orders') }}" class="btn {% if not current_filter %}btn-primary{% else %}btn-outline-primary{% endif %}">All <span class="badge bg-secondary">{{ status_counts.values()|sum }}</span></a>
    <a href="{{ url_for('orders.list_orders', filter_status='active') }}" class="btn {% if current_filter == 'active' %}btn-primary{% else %}btn-outline-primary{% endif %}">Active <span class="badge bg-secondary">{{ active_count }}</span></a>
    {% for status in statuses %}
    <a href="{{ url_for('orders.list_orders', filter_status=status) }}" class="btn {% if current_filter == status %}btn-primary{% else %}btn-outline-primary{% endif %}">
        {{ status|capitalize }} <span class="badge bg-secondary">{{ status_counts.get(status, 0) }}</span>
    </a>
    {% endfor %}
</div>


{% if orders %}
<div class="table-responsive">
    <table class="table table-striped table-hover table-sm">
        <thead>
            <tr>
                <th>Order ID</th>
                <th>Table</th>
                <th>Status</th>
                <th>Items</th>
                <th>Total</th>
                <th>Timestamp</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for order in orders %}
            {% set status_class = 'table-secondary' %} {# Default #}
            {% if order.status == 'pending' %} {% set status_class = 'table-warning' %}
            {% elif order.status == 'preparing' %} {% set status_class = 'table-info' %}
            {% elif order.status in ['ready', 'served'] %} {% set status_class = 'table-success' %}
            {% elif order.status == 'cancelled' %} {% set status_class = 'table-danger' %}
            {% endif %}

            <tr class="{{ status_class }}">
                <td><a href="{{ url_for('orders.view_order', order_id=order._id) }}" title="View Details">{{ order._id|string|truncate(8, True, '...') }}</a></td>
                <td>{{ order.table_number }}</td>
                <td>
                    <span class="badge
                        {% if order.status == 'pending' %} bg-warning text-dark
                        {% elif order.status == 'preparing' %} bg-info text-dark
                        {% elif order.status == 'ready' %} bg-primary
                        {% elif order.status == 'served' %} bg-success
                        {% elif order.status == 'cancelled' %} bg-danger
                        {% elif order.status == 'billed' %} bg-secondary
                        {% else %} bg-light text-dark {% endif %}">
                        {{ order.status|capitalize }}
                    </span>
                </td>
                <td>
                    {% if order.items %}
                    <ul class="list-unstyled mb-0 small">
                        {% for item in order.items[:3] %} {# Show first 3 items max #}
                        <li>{{ item.quantity }} x {{ item.name|truncate(25) }}</li>
                        {% endfor %}
                        {% if order.items|length > 3 %}<li>... ({{ order.items|length }} total)</li>{% endif %}
                    </ul>
                    {% else %}
                        No items
                    {% endif %}
                </td>
                <td>${{ "%.2f"|format(order.total_amount) }}</td>
                <td class="small">{{ order.timestamp_str }}</td>
                <td>
                    {% if order.status not in ['billed', 'cancelled'] %}
                    {# Quick status change dropdown #}
                     <form action="{{ url_for('orders.update_order_status', order_id=order._id) }}" method="POST" style="display: inline;">
                         <select name="status" class="form-select form-select-sm d-inline-block w-auto me-1" onchange="this.form.submit()">
                             <option value="">Change Status...</option>
                             {% for status in statuses %}
                                 {% if status != order.status and status != 'billed' %} {# Don't show current or billed #}
                                 <option value="{{ status }}">{{ status|capitalize }}</option>
                                 {% endif %}
                             {% endfor %}
                         </select>
                         {# Optional: Add a button if select doesn't submit reliably everywhere
                         <button type="submit" class="btn btn-sm btn-outline-secondary">Go</button> #}
                     </form>
                    <a href="{{ url_for('orders.view_order', order_id=order._id) }}" class="btn btn-sm btn-outline-info">View</a>
                    {% else %}
                     <a href="{{ url_for('orders.view_order', order_id=order._id) }}" class="btn btn-sm btn-outline-secondary">View</a>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<div class="alert alert-info">No orders found matching the criteria.</div>
{% endif %}
{% endblock %}