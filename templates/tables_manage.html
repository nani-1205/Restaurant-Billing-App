{% extends "base.html" %}
{% block title %}Table Management{% endblock %}

{% block content %}
    <h2>Table Management</h2>
    <hr>

    <!-- Add New Table Form -->
    <div class="card mb-4">
        <div class="card-header">Add New Table</div>
        <div class="card-body">
            <form action="{{ url_for('tables_manage') }}" method="POST">
                <div class="row g-3 align-items-end">
                    <div class="col-md-4">
                        <label for="table_number" class="form-label">Table Number/Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="table_number" name="table_number" required>
                    </div>
                    <div class="col-md-3">
                        <label for="capacity" class="form-label">Capacity <span class="text-danger">*</span></label>
                        <input type="number" min="1" class="form-control" id="capacity" name="capacity" required>
                    </div>
                    <div class="col-md-auto">
                        <button type="submit" class="btn btn-success">Add Table</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Table Grid/List -->
    <h3>Current Tables</h3>
    {% if tables %}
    <div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-4">
        {% for table in tables %}
        <div class="col">
            <div class="card h-100 table-card status-{{ table.status }}">
                <div class="card-body d-flex flex-column">
                    <h5 class="card-title">Table {{ table.table_number }}</h5>
                    <p class="card-text">Capacity: {{ table.capacity }}</p>
                    <p class="card-text">
                        Status: <span class="badge status-badge-{{ table.status }}">{{ table.status|capitalize }}</span>
                    </p>
                    <div class="mt-auto btn-toolbar justify-content-between" role="toolbar">
                         <div class="btn-group btn-group-sm" role="group">
                           {% if table.status == 'available' %}
                                <a href="{{ url_for('order_new', table_id=table._id) }}" class="btn btn-success">New Order</a>
                           {% elif table.status == 'occupied' and table.current_order_id %}
                                <a href="{{ url_for('order_view', order_id=table.current_order_id) }}" class="btn btn-info">View Order</a>
                           {% elif table.status == 'occupied' %}
                                <button class="btn btn-warning" disabled>Occupied (No Order Link)</button>
                            {% else %}
                                <button class="btn btn-secondary" disabled>Unavailable</button>
                           {% endif %}
                         </div>
                        <div class="btn-group btn-group-sm" role="group">
                             <!-- Status Change Dropdown -->
                             <div class="dropdown d-inline">
                                  <button class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                    Status
                                  </button>
                                  <ul class="dropdown-menu">
                                    {% for status in ['available', 'occupied', 'reserved', 'cleaning'] %}
                                        {% if status != table.status %}
                                        <li>
                                            <form action="{{ url_for('table_update_status', table_id=table._id) }}" method="POST" class="d-inline table-status-form">
                                                <input type="hidden" name="status" value="{{ status }}">
                                                <button type="submit" class="dropdown-item">{{ status|capitalize }}</button>
                                            </form>
                                        </li>
                                        {% endif %}
                                    {% endfor %}
                                  </ul>
                                </div>
                            <form action="{{ url_for('table_delete', table_id=table._id) }}" method="POST" class="d-inline" onsubmit="return confirm('Delete Table {{ table.table_number }}?');">
                                <button type="submit" class="btn btn-outline-danger" title="Delete Table">Ã—</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <p>No tables configured yet. Use the form above to add tables.</p>
    {% endif %}

{% endblock %}

{% block head_extra %}
<style>
/* Basic styling for table status */
.table-card.status-available { border-left: 5px solid var(--bs-success); }
.table-card.status-occupied { border-left: 5px solid var(--bs-danger); }
.table-card.status-reserved { border-left: 5px solid var(--bs-warning); }
.table-card.status-cleaning { border-left: 5px solid var(--bs-info); }

.status-badge-available { background-color: var(--bs-success); }
.status-badge-occupied { background-color: var(--bs-danger); }
.status-badge-reserved { background-color: var(--bs-warning); color: var(--bs-dark) !important; }
.status-badge-cleaning { background-color: var(--bs-info); color: var(--bs-dark) !important; }
</style>
{% endblock %}

{% block scripts_extra %}
<script>
// Optional: Enhance status update with AJAX if desired, instead of full page reload
// document.querySelectorAll('.table-status-form').forEach(form => {
//     form.addEventListener('submit', function(event) {
//         event.preventDefault(); // Stop default form submission
//         const formData = new FormData(this);
//         fetch(this.action, {
//             method: 'POST',
//             body: formData
//         })
//         .then(response => response.json())
//         .then(data => {
//             if (data.success) {
//                 window.location.reload(); // Reload to see changes
//             } else {
//                 alert('Error updating status: ' + data.error);
//             }
//         })
//         .catch(error => {
//             console.error('Error:', error);
//             alert('An error occurred while updating status.');
//         });
//     });
// });
</script>
{% endblock %}